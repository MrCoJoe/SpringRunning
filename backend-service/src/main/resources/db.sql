SELECT     (select group_concat(cipd.diag_name) from cis_in_pat_diag cipd where cipd.diag_type in ('34')   and cipd.visit_id = A.visit_id and cipd.is_primary = 1 and cipd.del_time is null group by cipd.visit_id) show_diag_name, B.CARD_TYPE, CASE WHEN EXISTS ( SELECT 1 FROM CIS_IN_PAT_TURN_REQUEST ctq WHERE  ctq.visit_id = a.visit_Id AND ctq.STATE < 3) THEN 1 ELSE 0 END AS turn_request_flag, (select adfn.kind from acc_dic_fee_nature adfn where adfn.id = a.fee_nature) fee_kind, B.CARD_DATA, B.ID_CARD_TYPE, B.ID_CARD, A.MR_NO, A.VISIT_ID, A.VISIT_NO, A.BED_ID, (CASE WHEN B.PLAT_PAT_ID IS NULL THEN B.PAT_NO ELSE B.PLAT_PAT_ID END) PAT_NO, A.WARD_IN_TIME, A.CLN_OUT_TIME, A.WARD_OUT_TIME, A.REG_TIME, A.WARD_ID, A.DEPT_ID, 2 SOURCE_TYPE, A.DEPT_ID isms_pp_dept_id, A.WORK_GROUP_ID isms_pp_work_group_id, (SELECT NAME FROM PUB_DEPT WHERE ID = A.DEPT_ID) DEPT_NAME, (SELECT NAME FROM PUB_WARD WHERE ID = A.WARD_ID) WARD_NAME, A.WORK_GROUP_ID, A.PLAN_OUT_DATE, A.is_Home_Bed, A.RESIDENT_DOCTOR, A.RESPONSIBILITY_DOCTOR, A.ADMISSION_DOCTOR, A.ATTENDING_DOCTOR, A.CHIEF_DOCTOR, A.PRIMARY_NURSE, A.MASTER_ID, A.CARE_LEVEL, A.EME_LEVEL, A.IN_WAY, A.STATE, A.BRANCH_CODE, (SELECT NAME FROM PUB_BRANCH where code = A.BRANCH_CODE) BRANCH_NAME, B.SEX, B.NAME, B.DATE_OF_BIRTH, B.PAT_ID, B.PRIVACY_LEVEL PRIVACY_LEVEL, C.NAME BED_NAME, C.TYPE BED_TYPE, IFNULL(C.ORD,99999) BED_ORD, C.CODE BED_CODE, IF(IFNULL(C.ID, 0) = 0, 'N', 'Y') AS IS_ONBED, D.PHASE_FLAG, CASE WHEN DATEDIFF(IFNULL(A.WARD_OUT_TIME, NOW()), A.WARD_IN_TIME) <= 0 THEN CONCAT(HOUR(TIMEDIFF(IFNULL(A.WARD_OUT_TIME, NOW()), A.WARD_IN_TIME)), '小时') ELSE CONCAT(DATEDIFF(IFNULL(A.WARD_OUT_TIME, NOW()), A.WARD_IN_TIME), '天') END IN_DAYS,A.IN_DIAG_NAME DIAG, D.TIME_BASE,B.DATE_OF_BIRTH AGE_P_0, IFNULL(A.CLN_OUT_TIME,SYSDATE()) AGE_P_1, 'YY3-200,YM1-3,MM6-12,MD1-6,DD0-31' AGE_P_2, (SELECT NAME FROM PUB_EMP WHERE ID = A.ATTENDING_DOCTOR) ATTENDING_NAME, NULL  NURSE_PAT_TOTAL, (SELECT (IFNULL(PREPAID_TOTAL, 0) - IFNULL(SELF_FEE_TOTAL, 0)) FROM CIS_IN_PAT_ACC WHERE VISIT_ID = A.VISIT_ID) REAL_BALANCE, (SELECT BALANCE FROM CIS_IN_PAT_ACC WHERE VISIT_ID = A.VISIT_ID) BALANCE,   0 ACC_FEE_TOTAL, NULL GROUP_CODE, NULL WEIGHT,NULL AVG_COST, NULL WARNING_LEVEL,  (SELECT GROUP_CONCAT(IFNULL(B.NAME, AA.ALLERGEN_BACKUP_NAME)) NAME               FROM PAT_REG_ALLERGEN AA                        LEFT JOIN PUB_ALLERGEN B ON AA.ALLERGEN_ID = B.ID               WHERE AA.SOURCE_TYPE = 2                 AND AA.INVALID_EMPID IS NULL                 AND AA.REG_ID = A.VISIT_ID) ALLERGEN_NAME,A.IN_DIAG_NAME, (SELECT NAME FROM PUB_DEPT WHERE ID = A.DEPT_ID) DEPT_NAME, (SELECT NAME FROM PUB_WARD WHERE ID = A.WARD_ID) WARD_NAME, (SELECT NAME FROM PUB_WORK_GROUP WHERE ID = A.WORK_GROUP_ID) WORK_GROUP_NAME, (SELECT NAME FROM PUB_EMP WHERE ID = A.RESIDENT_DOCTOR) RESIDENT_NAME, (SELECT NAME FROM PUB_EMP WHERE ID = A.ADMISSION_DOCTOR) ADMISSION_NAME, (SELECT NAME FROM PUB_EMP WHERE ID = A.CHIEF_DOCTOR) CHIEF_NAME, (SELECT NAME FROM ACC_DIC_FEE_NATURE WHERE ID = A.FEE_NATURE) FEE_NAME, ( SELECT GROUP_CONCAT( DIAG_NAME ) FROM CIS_IN_PAT_DIAG WHERE DEL_TIME IS NULL AND IS_PRIMARY = 1 AND VISIT_ID = A.VISIT_ID GROUP BY IS_PRIMARY ) PRIMARY_DIAG_NAME, (SELECT CHECKOUT_FEE FROM CIS_IN_PAT_ACC WHERE VISIT_ID = A.VISIT_ID) CHECKOUT_FEE, (SELECT FEE_TOTAL FROM CIS_IN_PAT_ACC WHERE VISIT_ID = A.VISIT_ID) FEE_TOTAL  FROM CIS_IN_PAT_REG A JOIN PAT_REGISTER B ON B.REG_ID = A.VISIT_ID LEFT JOIN PUB_WARD_BED C ON A.BED_ID = C.ID LEFT JOIN CIS_ORDER_PHASE D ON A.VISIT_ID = D.IN_VISIT_ID AND A.PHASE_SEQ = D.SEQ WHERE B.SOURCE_TYPE = 2 AND (A.IS_INVALID IS NULL OR A.IS_INVALID = 0) AND (B.IS_INVALID IS NULL OR B.IS_INVALID = 0)  AND (A.STATE IN( 2,4) ) AND A.WARD_ID = 2010023 ORDER BY A.WARD_ID, BED_ORD, C.CODE